<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API连接测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">HotGone API连接测试</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">后端连接状态</h2>
            <div id="connection-status" class="mb-4">
                <span class="text-yellow-600">正在测试连接...</span>
            </div>
            <button onclick="testConnection()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                重新测试连接
            </button>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">热点事件列表</h2>
            <div id="events-list">
                <span class="text-gray-500">等待加载事件数据...</span>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">爬虫功能测试</h2>
            <button onclick="triggerCrawl()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-4">
                触发爬虫
            </button>
            <div id="crawl-result" class="mt-4"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';

        async function testConnection() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<span class="text-yellow-600">正在测试连接...</span>';

            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    statusDiv.innerHTML = `
                        <div class="text-green-600">
                            ✅ 连接成功<br>
                            环境: ${data.environment}<br>
                            数据库: ${data.database}<br>
                            时间: ${new Date(data.timestamp).toLocaleString()}
                        </div>
                    `;
                    loadEvents();
                } else {
                    statusDiv.innerHTML = '<span class="text-red-600">❌ 连接失败</span>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="text-red-600">❌ 连接错误: ${error.message}</span>`;
            }
        }

        async function loadEvents() {
            const eventsDiv = document.getElementById('events-list');
            eventsDiv.innerHTML = '<span class="text-yellow-600">正在加载事件...</span>';

            try {
                const response = await fetch(`${API_BASE}/events`);
                const data = await response.json();
                
                if (data.events && data.events.length > 0) {
                    const eventsHtml = data.events.map(event => `
                        <div class="border-l-4 border-blue-500 pl-4 mb-4">
                            <h3 class="font-semibold">${event.title}</h3>
                            <p class="text-gray-600 text-sm">${event.description}</p>
                            <div class="flex gap-2 mt-2">
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${event.category}</span>
                                <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">重要性: ${event.importance}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                关键词: ${event.keywords.join(', ')}
                            </div>
                        </div>
                    `).join('');
                    
                    eventsDiv.innerHTML = `
                        <div class="text-green-600 mb-4">✅ 成功加载 ${data.events.length} 个事件</div>
                        ${eventsHtml}
                    `;
                } else {
                    eventsDiv.innerHTML = '<span class="text-yellow-600">⚠️ 未找到事件数据</span>';
                }
            } catch (error) {
                eventsDiv.innerHTML = `<span class="text-red-600">❌ 加载失败: ${error.message}</span>`;
            }
        }

        async function triggerCrawl() {
            const resultDiv = document.getElementById('crawl-result');
            resultDiv.innerHTML = '<span class="text-yellow-600">正在触发爬虫...</span>';

            try {
                const response = await fetch(`${API_BASE}/crawl/trigger`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="text-green-600">
                            ✅ 爬虫执行成功<br>
                            消息: ${data.message}<br>
                            数据库状态: ${data.database}<br>
                            ${data.demo_data ? `发现事件: ${data.demo_data.events_found}` : ''}
                        </div>
                    `;
                    
                    // 爬虫完成后重新加载事件列表
                    setTimeout(loadEvents, 1000);
                } else {
                    resultDiv.innerHTML = `<span class="text-red-600">❌ 爬虫执行失败: ${data.error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-600">❌ 爬虫触发失败: ${error.message}</span>`;
            }
        }

        // 页面加载时自动测试连接
        testConnection();
    </script>
</body>
</html>